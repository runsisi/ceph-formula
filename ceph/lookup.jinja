# As of release 2014.7.0, the grains.filter_by interface in salt-ssh
# does not support 'default' and 'base' keyword parameters, so do not
# use this formula under salt-ssh unless you change the code accordingly.

{% if grains['os_family'] in ['Debian', 'Deepin'] %}
{% set base = {
    'pkgs': {'ceph': '0.87-1' + grains['oscodename'],},
    'manage_repo': 1,
    'repos': [
        {'name': 'deb http://ceph.com/debian-giant ' + grains['oscodename'] + ' main',
         'humanname': 'ceph',
         'dist': grains['oscodename'],
         'file': '/etc/apt/sources.list.d/ceph.list',
         'key_url': 'https://ceph.com/git/?p=ceph.git;a=blob_plain;f=keys/release.asc',
        },
    ],
} %}
{% elif grains['os_family'] in ['RedHat'] %}
{% set base = {
    'pkgs': {'ceph': '0.87-0.el' + grains['osmajorrelease'],},
    'manage_repo': 1,
    'repos': [
        {'name': 'ceph',
         'humanname': 'ceph',
         'baseurl': 'http://ceph.com/rpm-giant/el' + grains['osmajorrelease'] + '/$basearch',
         'gpgcheck': '1',
         'gpgkey': 'https://ceph.com/git/?p=ceph.git;a=blob_plain;f=keys/release.asc',
        },
        {'name': 'base',
         'humanname': 'base',
         'baseurl': 'http://mirrors.ustc.edu.cn/centos/' + grains['osmajorrelease'] + '/os/$basearch',
         'gpgcheck': '1',
         'gpgkey': 'http://mirrors.ustc.edu.cn/centos/RPM-GPG-KEY-CentOS-' + grains['osmajorrelease'],
        },
        {'name': 'extras',
         'humanname': 'extras',
         'baseurl': 'http://mirrors.ustc.edu.cn/centos/' + grains['osmajorrelease'] + '/extras/$basearch',
         'gpgcheck': '1',
         'gpgkey': 'http://mirrors.ustc.edu.cn/centos/RPM-GPG-KEY-CentOS-' + grains['osmajorrelease'],
        },
        {'name': 'epel',
         'humanname': 'epel',
         'baseurl': 'http://mirrors.ustc.edu.cn/epel/' + grains['osmajorrelease'] + '/$basearch',
         'gpgcheck': '1',
         'gpgkey': 'http://mirrors.ustc.edu.cn/epel/RPM-GPG-KEY-EPEL-' + grains['osmajorrelease'],
        },
    ],
} %}
{% endif %}

{% set base = salt['grains.filter_by']({
    'default': base,
}, merge = salt['pillar.get']('ceph:base')) %}

{% set conf = salt['grains.filter_by']({
    'default': {
        'cluster': 'ceph',
        'mon_key': 'AQATGHJTUCBqIBAA7M2yafV1xctn1pgr3GcKPg==',
        'admin_key': 'AQBMGHJTkC8HKhAAJ7NH255wYypgm1oVuV41MA==',
        'bootstrap_osd_key': 'AQARG3JTsDDEHhAAVinHPiqvJkUi5Mww/URupw==',
        'bootstrap_mds_key': 'AQCztJdSyNb0NBAASA2yPZPuwXeIQnDJ9O8gVw==',

        'global': {
            'fsid': '08a80810-eff9-4982-8cf3-37aded9e1802',
            'authentication_type': 'cephx',
            'public_network': '10.118.4.0/24',
            'cluster_network': '10.118.4.0/24',
            'mon_initial_members': 'runsisi-hust,',
            'mon_host': '10.118.4.36:6789',
        },
    },
}, merge = salt['pillar.get']('ceph:conf')) %}

{% set mon = salt['grains.filter_by']({
    'default': {'mon_id': salt['grains.get']('host'),},
}, grain = 'host', merge = salt['pillar.get']('ceph:mon')) %}

{% set osd = salt['grains.filter_by']({
    'default': {
        'osds': [
            {'data': '/cephd1',},
            {'data': '/cephd2', 'jounal': '/tmp/cephd2-jounal'},
        ],
    },
}, grain = 'host', merge = salt['pillar.get']('ceph:osd')) %}
